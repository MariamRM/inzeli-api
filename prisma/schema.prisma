// ---------- Prisma / PostgreSQL ----------
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ---------- Core Catalog ----------
model Game {
  id            String          @id // e.g., TREX / CHESS / BILLIARD
  name          String
  category      String
  rooms         Room[]
  matches       Match[]
  TimelineEvent TimelineEvent[]

  // relations for sponsor extras (no breaking changes)
  SponsorGame       SponsorGame[]
  SponsorGameWallet SponsorGameWallet[]

  // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ ØªØ³ÙˆÙŠÙ† Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ØªØµÙ†ÙŠÙ
  @@index([name])
  @@index([category])
}

// ---------- Users ----------
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  displayName  String
  passwordHash String
  createdAt    DateTime @default(now())

  // Scores (global / public boards)
  permanentScore Int @default(0) // leaderboard points (win +1 / loss -1)
  creditPoints   Int @default(5) // consumable credits (new users start with 5)

  roomsHosted Room[]             @relation("RoomsHosted")
  roomPlayers RoomPlayer[]
  sponsors    UserSponsor[]
  matchParts  MatchParticipant[]
  timeline    TimelineEvent[]
  RoomStake   RoomStake[]

  // relations for sponsor extras
  SponsorGameWallet SponsorGameWallet[]

  // Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø«Ù„Ø§Ù‹
  @@index([displayName])
  @@index([createdAt])
}

// ---------- Rooms / Players / Stakes ----------
model Room {
  code       String @id
  gameId     String
  game       Game   @relation(fields: [gameId], references: [id])
  hostUserId String
  host       User   @relation("RoomsHosted", fields: [hostUserId], references: [id])

  status    String   @default("waiting") // waiting | running | ended
  createdAt DateTime @default(now())

  // Room setup before start
  targetWinPoints Int?
  allowZeroCredit Boolean @default(true)

  // Countdown
  timerSec  Int?
  startedAt DateTime?

  players       RoomPlayer[]
  matches       Match[]
  stakes        RoomStake[]
  TimelineEvent TimelineEvent[]

  // ğŸ” ÙÙ‡Ø§Ø±Ø³ Ù…ÙÙŠØ¯Ø© Ù„ØµÙØ­Ø§Øª Ø§Ù„ØºØ±Ù ÙˆØ§Ù„ØªØ§ÙŠÙ…Ø±
  @@index([gameId])
  @@index([hostUserId])
  @@index([status])
  @@index([createdAt])
  @@index([startedAt])
}

enum TeamSide {
  A
  B
}

model RoomPlayer {
  roomCode String
  userId   String
  joinedAt DateTime @default(now())

  // Team meta
  team     TeamSide? @default(A)
  isLeader Boolean   @default(false)

  room Room @relation(fields: [roomCode], references: [code], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomCode, userId])

  // ğŸ” Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠ Ø±ÙˆÙ…
  @@index([roomCode])
  @@index([userId])
  @@index([roomCode, team])
  @@index([roomCode, isLeader])
}

model RoomStake {
  roomCode   String
  userId     String
  amount     Int
  reservedAt DateTime @default(now())

  room Room @relation(fields: [roomCode], references: [code], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomCode, userId])

  // ğŸ” ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ù‡Ø§Ù†Ø§Øª (Ø¥Ù† Ø§Ø³ØªØ¹Ù…Ù„ØªÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
  @@index([reservedAt])
}

// ---------- Sponsors ----------
model Sponsor {
  code   String        @id
  name   String
  active Boolean       @default(true)
  users  UserSponsor[]

  // relations for sponsor extras
  SponsorGame       SponsorGame[]
  SponsorGameWallet SponsorGameWallet[]
  matches           Match[]             @relation("SponsorMatches")

  // ğŸ” Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ØªØ¨Ø©/Ù…ÙÙ„ØªØ±Ø©
  @@index([active])
  @@index([name])
}

model UserSponsor {
  userId      String
  sponsorCode String
  activatedAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sponsor Sponsor @relation(fields: [sponsorCode], references: [code], onDelete: Cascade)

  @@id([userId, sponsorCode])

  // ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„
  @@index([userId])
  @@index([activatedAt])
}

// ---------- Matches ----------
model Match {
  id        String   @id @default(uuid())
  roomCode  String?
  gameId    String
  createdAt DateTime @default(now())

  // NEW: link match to sponsor (optional) for reporting/leaderboards in sponsor scope
  sponsorCode String?
  sponsor     Sponsor? @relation("SponsorMatches", fields: [sponsorCode], references: [code], onDelete: SetNull)

  room  Room?              @relation(fields: [roomCode], references: [code], onDelete: SetNull)
  game  Game               @relation(fields: [gameId], references: [id])
  parts MatchParticipant[]

  // ğŸ” Ø£Ø¯Ø§Ø¡ Ø£ÙØ¶Ù„ Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù† ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
  @@index([gameId, createdAt])
  @@index([sponsorCode, gameId, createdAt])
  @@index([roomCode, createdAt])
  @@index([createdAt])
}

model MatchParticipant {
  matchId String
  userId  String
  outcome Outcome

  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([matchId, userId])

  // ğŸ” Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: WHERE userId = ? JOIN Match(gameId)
  @@index([userId, matchId])
  @@index([outcome])
}

enum Outcome {
  WIN
  LOSS
}

// ---------- Timeline ----------
model TimelineEvent {
  id        String   @id @default(uuid())
  userId    String?
  roomCode  String?
  gameId    String?
  kind      String // e.g., ROOM_CREATED, ROOM_JOINED, STAKE_SET, ROOM_STARTED, MATCH_FINISHED
  meta      Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  room Room? @relation(fields: [roomCode], references: [code], onDelete: SetNull)
  game Game? @relation(fields: [gameId], references: [id], onDelete: SetNull)

  // ğŸ” Ø¹Ø±Ø¶ â€œØ´Ø³Ø§Ù„ÙØ©ØŸâ€ Ø¨Ø³Ø±Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø±ÙˆÙ…/Ø§Ù„Ù„Ø¹Ø¨Ø©/Ø§Ù„Ù†ÙˆØ¹
  @@index([userId, createdAt])
  @@index([roomCode, createdAt])
  @@index([gameId, createdAt])
  @@index([kind, createdAt])
  @@index([createdAt])
}

// ---------- Sponsor extras (games & per-sponsor wallets) ----------
model SponsorGame {
  sponsorCode String
  gameId      String
  prizeAmount Int    @default(0)

  sponsor Sponsor @relation(fields: [sponsorCode], references: [code], onDelete: Cascade)
  game    Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([sponsorCode, gameId])

  // ğŸ” ÙÙ‡Ø§Ø±Ø³ Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª
  @@index([sponsorCode])
  @@index([gameId])
}

model SponsorGameWallet {
  userId      String
  sponsorCode String
  gameId      String
  pearls      Int      @default(5)
  updatedAt   DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sponsor Sponsor @relation(fields: [sponsorCode], references: [code], onDelete: Cascade)
  game    Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([userId, sponsorCode, gameId])

  // ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (leaderboard) Ù„ÙƒÙ„ Sponsor+Game
  // WHERE sponsorCode=? AND gameId=? ORDER BY pearls DESC
  // ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚Ù„ pearls ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙÙ‡Ø±Ø³ ÙŠØ­Ø³Ù† Ø§Ù„ØªØ±ØªÙŠØ¨
  @@index([sponsorCode, gameId, pearls])

  // ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
  @@index([userId])
  @@index([updatedAt])
}
